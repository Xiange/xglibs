
how to update xiange system:

first of all, you should use a disk image for easy simulation.
1. create image file
2. create patitions
3. format with ext4
4. losetup and mount
	losetup -P -f filename

there's tow way to make Xiange building environment:

Method 1: use stage 0 tarbal.
1. download stage 0 tarball form BaiduNetDisk, or SourceForge.
2. tar xaf to a local directory, such as /root/xg_stage0_2023.6
3. chroot to stage0.
4. change tmpfs size in chroot environment: it's important for compiling new packages.  
	mount /tmp -o remount,size=32G

	then goto step 6 in Method 2.
	


Method 2: use binary copiled packages:

1. check compiled packages of current version:

	gpkg ckstage 0 /var/xiange/packages

	make sure all packages in stage0 was compiled. (NOTE: stage0 is enough for compile stage1)

	check and install stage1 because some stage1 packages is needed when compile stage0 stages. (move stage1 packages to stage0)


2. prepare a root directory, such as /root/xiange-2022.2

	export XGROOT=/root/2022.2

3. create and mount xiange libs to new root directory: 

	mkdir -p $XGROOT/var/xiange/xglibs
	mount --bind /var/xiange/xglibs $XGROOT/var/xiange/xglibs


	mkdir -p $XGROOT/var/xiange/sources
	mkdir /mnt/bak/sources-2022.2
	mount --bind /var/xiange/sources $XGROOT/var/xiange/sources


4. install stage0 of current version to root directory:

	gpkg inststage 0 /var/xiange/packages


5. prepare username/group

	NOTE: use /etc/samples/group.saple and /etc/samples/passwd.sample

	install -m 0660 $XGROOT/etc/samples/group.sample $XGROOT/etc/group
	install -m 0660 $XGROOT/etc/samples/passwd.sample $XGROOT/etc/passwd

5. chroot to new root
	
	gpkg -chroot $XGROOT

	. /etc/profile
	
	pwconv
	grpconv

6. test user gpkg:

	su
	su -p gpkg -c "whoami"
	it should say "gpkg". (run su first if it return 1).

7. change compile parameters:


	REMOVE native if you want build a common release:

	-march=x86-64

	gpkg -info > /etc/xgparas
	vi $XGROOT//etc/xgparas
	gpkg -info



8. update glibc (linux-header first if needed)

	download source outside chroot environment: gpkg -d glibc

	gpkg -ip glibc

9. update bin-utils/gcc

	use cp -l -r to hard link copy exists source files. 

10. update stage 0 one by one with newest version:


how to install xiange:


1. update software via gpkg edit 
2. compile to package, with gpkg -ip
3. check if all softwares is ready to install for target stage with gpkg ckstage (in /var/xiange/packges)
4. install image with mkxgimg.sh

	mkxgimg.sh -s 0,1,2,3
		a) create a 8GB image at /root/xg64.img
		b) format with ext4
		c) install grub2
		d) install all softwares for specified stage, in /var/xiange/packages
		e1) update grub config in stage1
		e2) enable network manager in stage 1
		e3) enable sshd in stage 1
		f1) config gtk2, gtk3 in stage 2
		f2) enable slim, fvwm-xiange in stage 2
		f3) set default username:password to xiange:xiange
		g) specify os release tag
		h) update xglibs with git

		
6. compress with mkxgsqush.sh

		a) check /root/xg_sqh.img, use it directly if exists (useful for installing 2 archs)
		b1) create a 2G image file at /root/xg_sqh.img if not availeble
		b2) format with ext4
		b3) install grub2
		c) make sure /root/xg64.img is ready. quit if not available
		d) check if squash file /root/xiange-sqroot is newer than xg64.img
		d1) re-create /root/xiange-sqroot if xg64.img is newer.
		e1) mount /root/xiange-sqroot to 0
		e2) set xg64.img in xiange-sqroot to /dev/loop2
		e3) set /root/xg_sqh.img to /dev/loop1
		e4) mount xg_sqh.img to /mnt/1
		e5) mount xg64.img to /mnt/2
		f1) get blkid for root/xg_sqh.img
		f2) update grub.cfg with blkid
		f3) check kernels in xg64.img, copy to xg_sqh.img
		f4) prepare initrams
		g) copy xiange-sqroot to root/xg_sqh.img
		h) create cow.img for squashfs writting

5. burn /root/xg_sqh.img to USB for testing (with dd)

6, when kernel start

		a) grub will load specified kernel from xg_sqh.img (ext4)
		b) kernel load initramfs
		c) initramfs mount squash fs 
		d) chroot to xg64 as root device



-----------------------------------------------
Install Xiange Image to USB disk
-----------------------------------------------

please check ~/work/xiange/fvwm-xiange/src/libexec/xginstall.sh

"./xginstall.sh USB" to install to USB without format

select xg_sqh.img then wait copy done.

-----------------------------------------------
How to update Xiange Image
-----------------------------------------------

1. check /root/xg64.img , should be 8 GB. 
2. loop it: losetup -P /dev/loop0 xg64.img 
3. mount to /mnt/image: mount /dev/loop0p1 /mnt/image
4. link xglibs, sources, and packages to /mnt/image/var/xiange
	
	rm -rf  /mnt/image/var/xiange/xglibs/*
	mount --bind /var/xiange/xglibs /mnt/image/var/xiange/xglibs

	mount --bind /var/xiange/sources /mnt/image/var/xiange/sources 

	mount --bind /mnt/bak/sword/xiange/packages-x86_64-common /mnt/image/var/xiange/packages 

5. set XGROOT:

	export XGROOT=/mnt/image

6.	remove native in CFLAGS for common platform:

	gpkg -info > $XGROOT//etc/xgparas
	vi $XGROOT//etc/xgparas
	gpkg -info



7. update select packages with gpkg -ip
	or: re-compile all packages:

	gpkg stage1
	gpkg stage2
	gpkg stage3
	gpkg stage4


roll back:

	1. update /etc/xgpara with native?
	2. roll back /var/xiange/xglibs


